@page "/rabat"
@using BellaHair.Domain.Entities
@inject BellaHair.Application.Interfaces.IDataService DataService
@rendermode InteractiveServer

<div class="p-8">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-gray-900 mb-2 text-2xl font-semibold">Rabatter</h1>
            <p class="text-gray-600">Administrer stamkunde- og kampagnerabatter</p>
        </div>
        <button @onclick="NewRabat"
                class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Ny Rabat
        </button>
    </div>

    <!-- Filters -->
    <div class="mb-6 flex gap-2">
        <button @onclick="ShowAll"
                class="@GetFilterButtonClass("all")">
            Alle
        </button>

        <button @onclick="ShowStamkunde"
                class="@GetFilterButtonClass("Stamkunde")">
            Stamkunderabatter
        </button>

        <button @onclick="ShowKampagne"
                class="@GetFilterButtonClass("Kampagne")">
            Kampagnerabatter
        </button>
    </div>

    <!-- Stamkunderabatter Section -->
    @if ((selectedKategori == "all" || selectedKategori == "Stamkunde") && StamkundeRabatter.Any())
    {
        <div class="mb-8">
            <h2 class="text-gray-900 mb-4 text-lg font-semibold">Stamkunderabatter</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                @foreach (var rabat in StamkundeRabatter)
                {
                    var active = IsActive(rabat);
                    var procent = (rabat.Percentage ?? 0) * 100; // 0.05 -> 5

                    <div class="bg-white rounded-lg border @(active ? "border-green-300" : "border-gray-200") hover:shadow-lg transition-shadow">
                        <div class="p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="@GetLoyaltyColor(rabat.Percentage ?? 0) w-12 h-12 rounded-lg flex items-center justify-center">
                                        <span class="text-lg font-semibold">
                                            @procent.ToString("0.#")%
                                        </span>
                                    </div>
                                    <div>
                                        <h3 class="text-gray-900 font-medium">
                                            @GetLoyaltyTier(rabat.Percentage ?? 0)
                                        </h3>
                                        <p class="text-sm text-gray-600">@GetRabatLabel(rabat)</p>
                                      
                                    </div>
                                </div>
                                <span class="@(active ? "bg-green-100 text-green-700" : "bg-gray-100 text-gray-700") px-2 py-1 text-xs rounded">
                                    @(active ? "Aktiv" : "Inaktiv")
                                </span>
                            </div>

                            <div class="space-y-3">
                                <p class="text-sm text-gray-600">@rabat.Description</p>

                                @if (rabat.MinimumBeløb.HasValue)
                                {
                                    <p class="text-xs text-gray-500">Gælder fra @rabat.MinimumBeløb.Value.ToString("0.00") kr</p>
                                }

                                <div class="pt-4 border-t border-gray-100 space-y-2">
                                    <button class="w-full px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                                            @onclick="() => Edit(rabat)">
                                        Rediger
                                    </button>

                                    <button class="w-full px-4 py-2 border border-red-300 text-red-700 rounded-lg hover:bg-red-50"
                                            @onclick="() => ConfirmDelete(rabat)">
                                        Slet
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Kampagnerabatter Section -->
    @if ((selectedKategori == "all" || selectedKategori == "Kampagne") && KampagneRabatter.Any())
    {
        <div>
            <h2 class="text-gray-900 mb-4 text-lg font-semibold">Kampagnerabatter</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                @foreach (var rabat in KampagneRabatter)
                {
                    var active = IsActive(rabat);

                    <div class="bg-white rounded-lg border @(active ? "border-green-300" : "border-gray-200") hover:shadow-lg transition-shadow">
                        <div class="p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center gap-2">
                                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-gray-900 font-medium">@GetRabatLabel(rabat)</h3>

                                        <p class="text-xs text-gray-500">@rabat.Navn</p>
                                       
                                    </div>
                                </div>

                                <span class="@(active ? "bg-green-100 text-green-700" : "bg-gray-100 text-gray-700") px-2 py-1 text-xs rounded">
                                    @(active ? "Aktiv" : "Inaktiv")
                                </span>
                            </div>

                            <div class="space-y-3">
                                <p class="text-sm text-gray-600">@rabat.Description</p>

                                <p class="text-xs text-gray-500">
                                    Periode:
                                    @if (rabat.StartDato.HasValue)
                                    {
                                        @rabat.StartDato.Value.ToString("dd-MM-yyyy")
                                    }
                                    else
                                    {
                                        @("Ingen startdato")
                                    }
                                    –
                                    @if (rabat.SlutDato.HasValue)
                                    {
                                        @rabat.SlutDato.Value.ToString("dd-MM-yyyy")
                                    }
                                    else
                                    {
                                        @("Ingen slutdato")
                                    }
                                </p>

                                @if (rabat.MinimumBeløb.HasValue)
                                {
                                    <p class="text-xs text-gray-500">Gælder fra @rabat.MinimumBeløb.Value.ToString("0.00") kr</p>
                                }

                                <div class="pt-4 border-t border-gray-100 space-y-2">
                                    <button class="w-full px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                                            @onclick="() => Edit(rabat)">
                                        Rediger
                                    </button>

                                    <button class="w-full px-4 py-2 border border-red-300 text-red-700 rounded-lg hover:bg-red-50"
                                            @onclick="() => ConfirmDelete(rabat)">
                                        Slet
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    @if (!rabatter.Any())
    {
        <div class="text-center text-gray-500 mt-12">
            Ingen rabatter oprettet endnu.
        </div>
    }

    <!-- Create/Edit Modal -->
    @if (showDialog)
    {
        <div class="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-lg">
                <h2 class="text-lg font-semibold mb-4">
                    @(isEdit ? "Redigér rabat" : "Ny rabat")
                </h2>

                <div class="space-y-4">
                    <!-- TYPE ØVERST -->
                    <div>
                        <label class="b
text-sm text-gray-600 mb-1">Type</label>
                        <select class="w-full border p-2 rounded" @bind="selectedType">
                            <option value="Stamkunde">Stamkunderabat</option>
                            <option value="Kampagne">Kampagnerabat</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Navn</label>
                        <input class="w-full border p-2 rounded" @bind="current.Navn" />
                    </div>

                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Beskrivelse</label>
                        <textarea class="w-full border p-2 rounded" rows="3"
                                  @bind="current.Description"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Procent (0-100)</label>
                        <input type="number" min="0" max="100" step="0.1"
                               class="w-full border p-2 rounded"
                               @bind="percentageInput" />
                        <p class="text-xs text-gray-500 mt-1">
                            (Fx 10 = 10% → gemmes som 0.10)
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Fast beløb (kr, valgfri)</label>
                        <input type="number" step="0.01"
                               class="w-full border p-2 rounded"
                               @bind="current.FixedAmount" />
                        <p class="text-xs text-gray-500 mt-1">
                            Hvis både procent og fast beløb er sat, bruges procent først.
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Minimum beløb (valgfri)</label>
                        <input type="number" step="0.01" class="w-full border p-2 rounded"
                               @bind="current.MinimumBeløb" />
                    </div>

                    <div class="mt-2">
                        <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                            <input type="checkbox" class="rounded" @bind="current.Aktiv" />
                            <span>Aktiv</span>
                        </label>
                    </div>

                    @if (selectedType == "Kampagne")
                    {
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">Startdato</label>
                                <input type="date" class="w-full border p-2 rounded"
                                       @bind="current.StartDato" />
                            </div>

                            <div>
                                <label class="block text-sm text-gray-600 mb-1">Slutdato</label>
                                <input type="date" class="w-full border p-2 rounded"
                                       @bind="current.SlutDato" />
                            </div>
                        </div>
                    }
                </div>

                <div class="flex justify-end gap-2 mt-6">
                    <button class="px-4 py-2 rounded border hover:bg-gray-50"
                            @onclick="Close">
                        Annullér
                    </button>
                    <button class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
                            @onclick="Save">
                        Gem
                    </button>
                </div>
            </div>
        </div>
    }


    <!-- Delete confirm -->
    @if (showDelete)
    {
        <div class="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
                <h2 class="text-lg font-semibold mb-2">Slet rabat</h2>
                <p class="text-gray-600 mb-4">
                    Er du sikker på, at du vil slette <b>@toDelete?.Navn</b>?
                </p>

                <div class="flex justify-end gap-2">
                    <button class="px-4 py-2 rounded border hover:bg-gray-50"
                            @onclick="CancelDelete">
                        Annullér
                    </button>
                    <button class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700"
                            @onclick="DeleteConfirmed">
                        Slet
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private string selectedKategori = "all";

    private List<Rabat> rabatter = new();

    private string selectedType = "Stamkunde";


    // Stamkunde = har IKKE IsKampagne
    private IEnumerable<Rabat> StamkundeRabatter =>
        rabatter.Where(r => !r.IsKampagne);



    // Kampagne = IsKampagne == true
    private IEnumerable<Rabat> KampagneRabatter =>
        rabatter.Where(r => r.IsKampagne);

    private bool showDialog;
    private bool isEdit;
    private Rabat current = new();

    private bool showDelete;
    private Rabat? toDelete;

    private decimal percentageInput;

    protected override void OnInitialized()
    {
        Load();
    }

    private void Load()
    {
        rabatter = DataService.Rabatter.ToList();
    }

    // Filter handlers
    private void ShowAll() => selectedKategori = "all";
    private void ShowStamkunde() => selectedKategori = "Stamkunde";
    private void ShowKampagne() => selectedKategori = "Kampagne";

    private bool IsActive(Rabat rabat)
    {
        return rabat.Aktiv;
    }


    private string AsPercent(decimal? pct)
    {
        var value = (pct ?? 0) * 100;
        return $"{value:0.#}%";
    }

    private string GetFilterButtonClass(string kategori)
    {
        var baseClass = "px-4 py-2 rounded-lg";
        return selectedKategori == kategori
            ? $"{baseClass} bg-blue-600 text-white"
            : $"{baseClass} border border-gray-300 text-gray-700 hover:bg-gray-50";
    }

    private string GetLoyaltyColor(decimal percentage)
    {
        var value = percentage * 100;
        if (value == 5) return "bg-amber-700 text-white";   // Bronze
        if (value == 10) return "bg-gray-400 text-white";   // Sølv
        if (value == 15) return "bg-yellow-500 text-white"; // Guld
        return "bg-purple-100 text-purple-600";
    }

    private string GetLoyaltyTier(decimal percentage)
    {
        var value = percentage * 100;
        if (value == 5) return "Bronze";
        if (value == 10) return "Sølv";
        if (value == 15) return "Guld";
        return "Stamkunde";
    }

    private void NewRabat()
    {
        isEdit = false;
        current = new Rabat
        {
            Aktiv = true,
            IsKampagne = false
        };
        selectedType = "Stamkunde"; // default når man opretter ny
        percentageInput = 0;
        showDialog = true;
    }


    private void Edit(Rabat r)
    {
        isEdit = true;
        current = new Rabat
        {
            RabatId = r.RabatId,
            Navn = r.Navn,
            Description = r.Description,
            Percentage = r.Percentage,
            MinimumBeløb = r.MinimumBeløb,
            FixedAmount = r.FixedAmount,
            IsKampagne = r.IsKampagne,
            StartDato = r.StartDato,
            SlutDato = r.SlutDato,
            Aktiv = r.Aktiv
        };

        percentageInput = (r.Percentage ?? 0) * 100;

        // 👇 Dette er vigtigt:
        selectedType = r.IsKampagne ? "Kampagne" : "Stamkunde";

        showDialog = true;
    }



    private void Close()
    {
        showDialog = false;
        current = new Rabat();
        percentageInput = 0;
    }

    private async Task Save()
    {
        if (percentageInput > 0)
        {
            current.Percentage = percentageInput / 100;
        }
        else
        {
            current.Percentage = null;
        }

        // Sæt IsKampagne ud fra valgt type
        current.IsKampagne = selectedType == "Kampagne";

        // Hvis det IKKE er kampagne, så giver dato-range ikke mening → ryd dem
        if (!current.IsKampagne)
        {
            current.StartDato = null;
            current.SlutDato = null;
        }

        if (string.IsNullOrWhiteSpace(current.Navn))
            return;

        if (isEdit)
            await DataService.UpdateRabatAsync(current);
        else
            await DataService.AddRabatAsync(current);

        showDialog = false;
        Load();
    }



    private void ConfirmDelete(Rabat r)
    {
        toDelete = r;
        showDelete = true;
    }

    private void CancelDelete()
    {
        showDelete = false;
        toDelete = null;
    }

    private async Task DeleteConfirmed()
    {
        if (toDelete is not null)
            await DataService.DeleteRabatAsync(toDelete.RabatId);

        showDelete = false;
        toDelete = null;
        Load();
    }

    private string GetRabatLabel(Rabat rabat)
    {
        var hasPct = rabat.Percentage.HasValue && rabat.Percentage.Value > 0;
        var hasFixed = rabat.FixedAmount.HasValue && rabat.FixedAmount.Value > 0;

        if (hasPct && hasFixed)
        {
            // fx "10% / 100 kr"
            return $"{AsPercent(rabat.Percentage)} / {rabat.FixedAmount.Value:0.##} kr";
        }

        if (hasPct)
        {
            return AsPercent(rabat.Percentage);
        }

        if (hasFixed)
        {
            return $"{rabat.FixedAmount.Value:0.##} kr";
        }

        return "Ingen rabat";
    }


}