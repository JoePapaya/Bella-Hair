@page "/booking"
@rendermode InteractiveServer
@using BellaHair.Domain.Entities
@using BellaHair.Domain.Services
@using BellaHair.Domain.Enums
@inject BellaHair.Application.Interfaces.IDataService DataService
@inject BellaHair.Application.Interfaces.IBookingApplicationService BookingAppService
@inject BellaHair.Application.Interfaces.IRabatService RabatService
@inject BellaHair.Application.Interfaces.ILoyaltyService LoyaltyService
@inject IJSRuntime JSRuntime

<div class="p-8">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-gray-900 mb-2">Bookinger</h1>
            <p class="text-gray-600">Administrer alle bookinger</p>
        </div>

        <button @onclick="NewBooking"
                class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Ny Booking
        </button>
    </div>

    <!-- Status Filters -->
    <div class="flex gap-2 mb-6">
        <button @onclick="@(() => SetStatusFilter("all"))"
                class="@GetFilterButtonClass("all")">
            Alle
        </button>

        <button @onclick="@(() => SetStatusFilter("Kommende"))"
                class="@GetFilterButtonClass("Kommende")">
            Kommende
        </button>

        <button @onclick="@(() => SetStatusFilter("Gennemført"))"
                class="@GetFilterButtonClass("Gennemført")">
            Gennemført
        </button>
    </div>

    <!-- Bookings List -->
    <div class="bg-white rounded-lg border border-gray-200">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-gray-900">@GetStatusTitle()</h2>
        </div>

        <div class="p-6">
            <div class="space-y-6">

                @if (selectedStatus == "all")
                {
                    <!-- Først KOMMENDE bookinger -->
                    @if (KommendeBookinger.Any())
                    {
                        <div>
                            <h3 class="text-gray-800 mb-3 text-sm font-semibold">Kommende bookinger</h3>
                            <div class="space-y-3">
                                @foreach (var booking in KommendeBookinger)
                                {
                                    @BookingRow(booking)
                                }
                            </div>
                        </div>
                    }

                    <!-- Derefter GENNEMFØRTE bookinger -->
                    @if (GennemførteBookinger.Any())
                    {
                        <div class="pt-4 border-t border-gray-200">
                            <h3 class="text-gray-800 mb-3 text-sm font-semibold">Gennemførte bookinger</h3>
                            <div class="space-y-3">
                                @foreach (var booking in GennemførteBookinger)
                                {
                                    @BookingRow(booking)
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="space-y-3">
                        @foreach (var booking in SortedFilteredBookinger)
                        {
                            @BookingRow(booking)
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Booking Dialog -->
@if (showDialog)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full space-y-3">
            <h2 class="text-gray-900 mb-2">@((isEditing ? "Rediger booking" : "Ny booking"))</h2>

            <div>
                <label class="block text-sm text-gray-600 mb-1">Kunde</label>
                <select class="w-full border p-2 rounded" @bind="editModel.KundeId">
                    @foreach (var k in DataService.Kunder)
                    {
                        <option value="@k.KundeId">@k.Navn</option>
                    }
                </select>
            </div>


            <div>
                <label class="block text-sm text-gray-600 mb-1">Behandling</label>
                <select class="w-full border p-2 rounded" @onchange="OnBehandlingChanged">
                    @foreach (var b in DataService.Behandlinger)
                    {
                        <option value="@b.BehandlingId"
                                selected="@(b.BehandlingId == editModel.BehandlingId)">
                            @b.Navn
                        </option>
                    }
                </select>

            </div>

            <div>
                <label class="block text-sm text-gray-600 mb-1">Medarbejder</label>
                <select class="w-full border p-2 rounded" @bind="editModel.MedarbejderId">
                    @foreach (var m in DataService.Medarbejdere)
                    {
                        <option value="@m.MedarbejderId">@m.Navn</option>
                    }
                </select>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Dato</label>
                    <input type="date"
                           class="w-full border p-2 rounded"
                           value="@datoInput"
                           @onchange="OnDateChanged" />
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Tid</label>
                    <input type="time"
                           class="w-full border p-2 rounded"
                           value="@tidInput"
                           @onchange="OnTimeChanged" />
                </div>
            </div>

            <div>
                <label class="block text-sm text-gray-600 mb-1">Varighed (min)</label>
                <input type="number" class="w-full border p-2 rounded" @bind="editModel.Varighed" />
            </div>

            <div>
                <label class="block text-sm text-gray-600 mb-1">Status</label>

                @if (isEditing && isOriginallyCompleted)
                {
                    <!-- Booking VAR allerede gennemført, da dialogen blev åbnet → lås -->
                    <select class="w-full border p-2 rounded bg-gray-100 text-gray-600" disabled>
                        <option value="@BookingStatus.Gennemført">Gennemført</option>
                    </select>

                    <p class="text-xs text-gray-500 mt-1">
                        Status kan ikke ændres for en gennemført booking, fordi der kan være oprettet faktura.
                    </p>
                }
                else
                {
                    <!-- Ny booking ELLER en der ikke var gennemført fra start → frit valg -->
                    <select class="w-full border p-2 rounded" @bind="editModel.Status">
                        <option value="@BookingStatus.Kommende">Kommende</option>
                        <option value="@BookingStatus.Gennemført">Gennemført</option>
                    </select>
                }
            </div>



            <div class="flex justify-end gap-2 pt-2">
                <button class="px-4 py-2 border rounded-lg hover:bg-gray-50"
                        @onclick="CloseDialog">
                    Annuller
                </button>

                <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                        @onclick="SaveBooking">
                    Gem
                </button>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation -->
@if (deleteBookingId.HasValue)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <h2 class="text-gray-900 mb-2">Slet booking?</h2>
            <p class="text-gray-600 mb-6">Er du sikker? Dette kan ikke fortrydes.</p>

            <div class="flex justify-end gap-2">
                <button @onclick="@(() => deleteBookingId = null)"
                        class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                    Annuller
                </button>

                <button @onclick="ConfirmDelete"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Slet
                </button>
            </div>
        </div>
    </div>
}

@code {
    private bool showDialog = false;
    private bool isEditing = false;
    private Booking editModel = new();

    private string datoInput = DateTime.Now.ToString("yyyy-MM-dd");
    private string tidInput = DateTime.Now.ToString("HH:mm");

    private int? deleteBookingId;
    private string selectedStatus = "all";
    private string? errorMessage;

    private bool isOriginallyCompleted = false;


    private void OnDateChanged(ChangeEventArgs e)
    {
        datoInput = e.Value?.ToString() ?? DateTime.Now.ToString("yyyy-MM-dd");
    }

    private void OnTimeChanged(ChangeEventArgs e)
    {
        tidInput = e.Value?.ToString() ?? DateTime.Now.ToString("HH:mm");
    }

    // --- Hjælpe-properties til sortering / filtrering ---

    private IEnumerable<Booking> AlleBookinger =>
        DataService.Bookinger.OrderBy(b => b.Tidspunkt);

    private IEnumerable<Booking> KommendeBookinger =>
        DataService.Bookinger
            .Where(b => b.Status == BookingStatus.Kommende)
            .OrderBy(b => b.Tidspunkt);

    private IEnumerable<Booking> GennemførteBookinger =>
        DataService.Bookinger
            .Where(b => b.Status == BookingStatus.Gennemført)
            .OrderByDescending(b => b.Tidspunkt);

    private IEnumerable<Booking> SortedFilteredBookinger =>
        selectedStatus switch
        {
            "Kommende" => KommendeBookinger,
            "Gennemført" => GennemførteBookinger,
            _ => AlleBookinger
        };

    private void SetStatusFilter(string status) => selectedStatus = status;

    private string GetFilterButtonClass(string status)
    {
        var baseCss = "px-3 py-1 rounded-lg border text-sm ";
        return selectedStatus == status
            ? baseCss + "bg-blue-600 text-white border-blue-600"
            : baseCss + "bg-white text-gray-700 border-gray-300 hover:bg-gray-50";
    }

    private string GetStatusBadgeClass(BookingStatus status) =>
        status switch
        {
            BookingStatus.Kommende => "bg-blue-100 text-blue-700",
            BookingStatus.Gennemført => "bg-gray-100 text-gray-700",
            _ => "bg-gray-100 text-gray-700"
        };

    private string GetStatusTitle() =>
        selectedStatus switch
        {
            "Kommende" => "Kommende bookinger",
            "Gennemført" => "Gennemførte bookinger",
            _ => "Alle bookinger"
        };

    private async void NewBooking()
    {
        isEditing = false;

        var førsteBehandling = DataService.Behandlinger.FirstOrDefault();
        var førsteMedarbejder = DataService.Medarbejdere.FirstOrDefault();

        if (førsteMedarbejder == null)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Du skal oprette mindst én medarbejder før du kan lave en booking.");
            return;
        }

        editModel = new Booking
        {
            Status = BookingStatus.Kommende,
            BehandlingId = førsteBehandling?.BehandlingId ?? 0,
            Varighed = førsteBehandling?.VarighedMinutter ?? 30,
            MedarbejderId = førsteMedarbejder.MedarbejderId
        };

        isOriginallyCompleted = false;

        datoInput = DateTime.Now.ToString("yyyy-MM-dd");
        tidInput = DateTime.Now.ToString("HH:mm");

        showDialog = true;
    }
    private string GetLoyaltyText(LoyaltyTier tier) => tier switch
    {
        LoyaltyTier.Bronze => "Bronze",
        LoyaltyTier.Silver => "Sølv",
        LoyaltyTier.Gold => "Guld",
        _ => ""
    };


    private string GetDiscountLabel(DiscountResult calc, Kunde? kunde)
    {
        var rabat = calc.AppliedDiscount;
        if (rabat is null)
            return "Rabat";

        // Kampagnerabat → vis altid navnet (fx "Nytårskampagne")
        if (rabat.IsKampagne)
        {
            return string.IsNullOrWhiteSpace(rabat.Navn)
                ? "Rabat"
                : rabat.Navn;
        }

        // Stamkunderabat → vis kun navnet hvis kundens LoyaltyTier matcher navnet
        if (kunde is not null &&
            kunde.LoyaltyTier != LoyaltyTier.None &&
            !string.IsNullOrWhiteSpace(rabat.Navn))
        {
            var tierText = GetLoyaltyText(kunde.LoyaltyTier); // "Bronze", "Sølv", "Guld"

            if (!string.IsNullOrWhiteSpace(tierText) &&
                rabat.Navn.Contains(tierText, StringComparison.OrdinalIgnoreCase))
            {
                // Fx kunde tier = Bronze, rabat.Navn = "Stamkunde Bronze"
                return rabat.Navn;
            }
        }

        return "Rabat";
    }




    private async Task EditBooking(int id)
    {
        var b = await BookingAppService.GetByIdAsync(id);
        if (b == null) return;

        editModel = new Booking
        {
            BookingId = b.BookingId,
            KundeId = b.KundeId,
            BehandlingId = b.BehandlingId,
            MedarbejderId = b.MedarbejderId,
            Tidspunkt = b.Tidspunkt,
            Varighed = b.Varighed,
            Status = b.Status,
            ValgtRabat = b.ValgtRabat,

          
        };


        isOriginallyCompleted = (b.Status == BookingStatus.Gennemført);

        datoInput = b.Tidspunkt.ToString("yyyy-MM-dd");
        tidInput = b.Tidspunkt.ToString("HH:mm");

        isEditing = true;
        showDialog = true;
    }

    private async Task SaveBooking()
    {
        errorMessage = null;

        if (editModel.MedarbejderId == 0)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Vælg en medarbejder før du gemmer.");
            return;
        }

        if (DateTime.TryParse($"{datoInput} {tidInput}", out var parsed))
        {
            editModel.Tidspunkt = parsed;
        }

        try
        {
            if (isEditing)
                await BookingAppService.UpdateAsync(editModel);
            else
                await BookingAppService.CreateAsync(editModel);

            showDialog = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            var inner = ex.InnerException?.Message ?? ex.Message;
            errorMessage = inner;
            await JSRuntime.InvokeVoidAsync("console.error", ex.ToString());
            await JSRuntime.InvokeVoidAsync("alert", inner);
        }
    }

    private void OnBehandlingChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var id))
        {
            editModel.BehandlingId = id;

            var behandling = DataService.Behandlinger
                .FirstOrDefault(b => b.BehandlingId == id);

            if (behandling != null)
            {
                // Her tager vi varighed direkte fra behandlingen 💪
                editModel.Varighed = behandling.VarighedMinutter;
            }
        }
    }

    private void OnBehandlingChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var id))
        {
            editModel.BehandlingId = id;

            var behandling = DataService.Behandlinger
                .FirstOrDefault(b => b.BehandlingId == id);

            if (behandling != null)
            {
                // Her tager vi varighed direkte fra behandlingen 💪
                editModel.Varighed = behandling.VarighedMinutter;
            }
        }
    }


    private void CloseDialog()
    {
        showDialog = false;
        editModel = new Booking();
    }

    private async Task ConfirmDelete()
    {
        if (!deleteBookingId.HasValue)
            return;

        try
        {
            await BookingAppService.DeleteAsync(deleteBookingId.Value);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            await JSRuntime.InvokeVoidAsync("alert", $"Fejl ved sletning: {ex.Message}");
        }
        finally
        {
            deleteBookingId = null;
            StateHasChanged();
        }
    }

    // Lille hjælpemetode for at undgå duplikeret markup
    private RenderFragment BookingRow(Booking booking) => __builder =>
    {
        var kunde = DataService.Kunder.FirstOrDefault(k => k.KundeId == booking.KundeId);
        var behandling = DataService.Behandlinger.FirstOrDefault(t => t.BehandlingId == booking.BehandlingId);
        var medarbejder = DataService.Medarbejdere.FirstOrDefault(m => m.MedarbejderId == booking.MedarbejderId);

        // ---------- PRIS / RABAT LOGIK ----------
        decimal finalPrice;
        decimal? originalPriceToShow = null;
        string? rabatLabel = null;
        bool hasRabat = false;

        if (booking.Status == BookingStatus.Gennemført)
        {
            // Brug snapshot fra Faktura
            var faktura = DataService.Fakturaer.FirstOrDefault(f => f.BookingId == booking.BookingId);

            if (faktura is not null)
            {
                finalPrice = faktura.TotalBeløb;

                if (faktura.RabatBeløb > 0)
                {
                    originalPriceToShow = faktura.Beløb;
                    hasRabat = true;
                    rabatLabel = string.IsNullOrWhiteSpace(faktura.RabatTekst)
                        ? "Rabat"
                        : faktura.RabatTekst;
                }
            }
            else
            {
                // Fallback hvis der mangler faktura (burde ikke ske):
                var calc = RabatService.BeregnBedsteRabat(
                    behandling?.Pris ?? 0,
                    kunde,
                    null,
                    booking.Tidspunkt
                );

                finalPrice = calc.FinalPrice;

                if (calc.AppliedDiscount is not null && calc.FinalPrice < calc.OriginalPrice)
                {
                    hasRabat = true;
                    originalPriceToShow = calc.OriginalPrice;
                    rabatLabel = GetDiscountLabel(calc, kunde);
                }
            }
        }
        else
        {
            // Kommende booking → brug live rabatberegning
            var calc = RabatService.BeregnBedsteRabat(
                behandling?.Pris ?? 0,
                kunde,
                null,
                booking.Tidspunkt
            );

            finalPrice = calc.FinalPrice;

            if (calc.AppliedDiscount is not null && calc.FinalPrice < calc.OriginalPrice)
            {
                hasRabat = true;
                originalPriceToShow = calc.OriginalPrice;
                rabatLabel = GetDiscountLabel(calc, kunde);
            }
        }

        // ---------------- RÆKKE-MARKUP ----------------
        __builder.OpenElement(0, "div");
        __builder.AddAttribute(1, "class", "flex items-center gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors");

        // venstre side
        __builder.OpenElement(2, "div");
        __builder.AddAttribute(3, "class", "flex-1 min-w-0");

        // navn + badges
        __builder.OpenElement(4, "div");
        __builder.AddAttribute(5, "class", "flex items-center gap-2 mb-1");

        // kundenavn
        __builder.OpenElement(6, "p");
        __builder.AddAttribute(7, "class", "text-gray-900");
        __builder.AddContent(8, kunde?.Navn);
        __builder.CloseElement(); // p

        // Firma badge
        if (kunde?.KundeType == KundeType.Firma)
        {
            __builder.OpenElement(9, "span");
            __builder.AddAttribute(10, "class", "px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-700");
            __builder.AddContent(11, "Firma");
            __builder.CloseElement(); // span
        }

        // Loyalty badge
        if (kunde is not null && kunde.LoyaltyTier != LoyaltyTier.None)
        {
            var tierText = GetLoyaltyText(kunde.LoyaltyTier);

            __builder.OpenElement(12, "span");
            __builder.AddAttribute(13, "class", "px-2 py-0.5 rounded text-xs bg-purple-100 text-purple-700");
            __builder.AddContent(14, tierText);
            __builder.CloseElement(); // span
        }


        // Status badge
        __builder.OpenElement(15, "span");
        __builder.AddAttribute(16, "class", $"{GetStatusBadgeClass(booking.Status)} px-2 py-0.5 rounded-full text-xs");
        __builder.AddContent(17, booking.Status.ToString());
        __builder.CloseElement(); // span

        __builder.CloseElement(); // div (navn + badges)

        // behandling
        __builder.OpenElement(18, "p");
        __builder.AddAttribute(19, "class", "text-sm text-gray-600");
        __builder.AddContent(20, behandling?.Navn);
        __builder.CloseElement(); // p

        // medarbejder
        __builder.OpenElement(21, "p");
        __builder.AddAttribute(22, "class", "text-xs text-gray-500");
        __builder.AddContent(23, $"Medarbejder: {medarbejder?.Navn}");
        __builder.CloseElement(); // p

        __builder.CloseElement(); // venstre side div

        // midten: tid
        __builder.OpenElement(24, "div");
        __builder.AddAttribute(25, "class", "text-right");
        __builder.OpenElement(26, "p");
        __builder.AddAttribute(27, "class", "text-gray-900");
        __builder.AddContent(28, booking.Tidspunkt.ToString("ddd dd. MMM yyyy"));
        __builder.CloseElement();
        __builder.OpenElement(29, "p");
        __builder.AddAttribute(30, "class", "text-sm text-gray-600");
        __builder.AddContent(31, booking.Tidspunkt.ToString("HH:mm"));
        __builder.CloseElement();
        __builder.OpenElement(32, "p");
        __builder.AddAttribute(33, "class", "text-sm text-gray-600");
        __builder.AddContent(34, $"{booking.Varighed} min");
        __builder.CloseElement();
        __builder.CloseElement(); // midten

        // højre: pris + rabat
        __builder.OpenElement(35, "div");
        __builder.AddAttribute(36, "class", "text-right min-w-[140px]");

        __builder.OpenElement(37, "p");
        __builder.AddAttribute(38, "class", "text-gray-900");
        __builder.AddContent(39, $"{Math.Round(finalPrice)} kr");
        __builder.CloseElement(); // p

        if (hasRabat && originalPriceToShow.HasValue)
        {
            __builder.OpenElement(40, "p");
            __builder.AddAttribute(41, "class", "text-xs text-gray-400 line-through");
            __builder.AddContent(42, $"{originalPriceToShow.Value} kr");
            __builder.CloseElement(); // p

            if (!string.IsNullOrWhiteSpace(rabatLabel))
            {
                __builder.OpenElement(43, "p");
                __builder.AddAttribute(44, "class", "text-xs text-green-600");
                __builder.AddContent(45, rabatLabel);
                __builder.CloseElement(); // p
            }
        }

        __builder.CloseElement(); // pris-div

        // actions
        __builder.OpenElement(46, "div");
        __builder.AddAttribute(47, "class", "flex gap-2");

        __builder.OpenElement(48, "button");
        __builder.AddAttribute(49, "class", "p-2 hover:bg-gray-200 rounded");
        __builder.AddAttribute(50, "onclick", EventCallback.Factory.Create(this, () => EditBooking(booking.BookingId)));
        __builder.AddContent(51, "✏️");
        __builder.CloseElement(); // button

        if (booking.Status != BookingStatus.Gennemført)
        {
            __builder.OpenElement(52, "button");
            __builder.AddAttribute(53, "class", "p-2 hover:bg-gray-200 rounded text-red-600");
            __builder.AddAttribute(54, "onclick", EventCallback.Factory.Create(this, () => deleteBookingId = booking.BookingId));
            __builder.AddContent(55, "🗑️");
            __builder.CloseElement(); // button
        }

        __builder.CloseElement(); // actions-div

        __builder.CloseElement(); // row div



    };

}
