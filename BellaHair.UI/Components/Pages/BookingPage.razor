@page "/booking"
@rendermode InteractiveServer
@using BellaHair.Domain.Entities
@using BellaHair.Domain.Services
@inject BellaHair.Application.Interfaces.IDataService DataService
@inject BellaHair.Application.Interfaces.IBookingApplicationService BookingAppService
@inject BellaHair.Application.Interfaces.IRabatService RabatService
@inject IJSRuntime JSRuntime

<div class="p-8">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-gray-900 mb-2">Bookinger</h1>
            <p class="text-gray-600">Administrer alle bookinger</p>
        </div>

        <button @onclick="NewBooking"
                class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Ny Booking
        </button>
    </div>

    <!-- Status Filters -->
    <div class="flex gap-2 mb-6">
        <button @onclick="@(() => SetStatusFilter("all"))"
                class="@GetFilterButtonClass("all")">
            Alle
        </button>

        <button @onclick="@(() => SetStatusFilter("Bekræftet"))"
                class="@GetFilterButtonClass("Bekræftet")">
            Bekræftet
        </button>

        <button @onclick="@(() => SetStatusFilter("Afventer"))"
                class="@GetFilterButtonClass("Afventer")">
            Afventer
        </button>

        <button @onclick="@(() => SetStatusFilter("Gennemført"))"
                class="@GetFilterButtonClass("Gennemført")">
            Gennemført
        </button>
    </div>

    <!-- Bookings List -->
    <div class="bg-white rounded-lg border border-gray-200">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-gray-900">@GetStatusTitle()</h2>
        </div>

        <div class="p-6">
            <div class="space-y-4">
                @foreach (var booking in SortedFilteredBookinger)
                {
                    var kunde = DataService.Kunder.FirstOrDefault(k => k.KundeId == booking.KundeId);
                    var behandling = DataService.Behandlinger.FirstOrDefault(t => t.BehandlingId == booking.BehandlingId);
                    var medarbejder = DataService.Medarbejdere.FirstOrDefault(m => m.MedarbejderId == booking.MedarbejderId);

                    // Brug RabatService til at beregne bedste rabat
                    var discountCalc = RabatService.BeregnBedsteRabat(
                    behandling?.Pris ?? 0,
                    kunde,
                    null,               // altid automatisk bedste rabat
                    booking.Tidspunkt   // 🔹 vigtig: bookingens dato
                    );



                    <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <p class="text-gray-900">@kunde?.Navn</p>

                                @if (!string.IsNullOrEmpty(kunde?.LoyaltyTier))
                                {
                                    <span class="px-2 py-0.5 rounded text-xs bg-purple-100 text-purple-700">
                                        @kunde!.LoyaltyTier
                                    </span>
                                }

                                <span class="@GetStatusBadgeClass(booking.Status) px-2 py-0.5 rounded-full text-xs">
                                    @booking.Status.ToString()
                                </span>
                            </div>

                            <p class="text-sm text-gray-600">@behandling?.Navn</p>
                            <p class="text-xs text-gray-500">Medarbejder: @medarbejder?.Navn</p>
                        </div>

                        <div class="text-right">
                            <p class="text-gray-900">@booking.Tidspunkt.ToString("ddd dd. MMM yyyy")</p>
                            <p class="text-sm text-gray-600">@booking.Tidspunkt.ToString("HH:mm")</p>
                            <p class="text-sm text-gray-600">@booking.Varighed min</p>
                        </div>

                        <div class="text-right min-w-[140px]">
                            <p class="text-gray-900">@Math.Round(discountCalc.FinalPrice) kr</p>
                            @if (discountCalc.AppliedDiscount != null)
                            {
                                <p class="text-xs text-gray-400 line-through">@discountCalc.OriginalPrice kr</p>
                                <p class="text-xs text-green-600">
                                    @discountCalc.AppliedDiscount.Navn
                                    @if (!string.IsNullOrWhiteSpace(discountCalc.AppliedDiscount.Code))
                                    {
                                        <span>(@discountCalc.AppliedDiscount.Code)</span>
                                    }
                                </p>
                            }
                        </div>

                        <div class="flex gap-2">
                            <button @onclick="@(() => EditBooking(booking.BookingId))"
                                    class="p-2 hover:bg-gray-200 rounded">
                                ✏️
                            </button>

                            @if (booking.Status != BookingStatus.Gennemført)
                            {
                                <button @onclick="@(() => deleteBookingId = booking.BookingId)"
                                        class="p-2 hover:bg-gray-200 rounded text-red-600">
                                    🗑️
                                </button>
                            }
                        </div>

                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Booking Dialog -->
@if (showDialog)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full space-y-3">
            <h2 class="text-gray-900 mb-2">@((isEditing ? "Rediger booking" : "Ny booking"))</h2>

            <div>
                <label class="block text-sm text-gray-600 mb-1">Kunde</label>
                <select class="w-full border p-2 rounded" @bind="editModel.KundeId">
                    @foreach (var k in DataService.Kunder)
                    {
                        <option value="@k.KundeId">@k.Navn</option>
                    }
                </select>
            </div>

            <div>
                <label class="block text-sm text-gray-600 mb-1">Behandling</label>
                <select class="w-full border p-2 rounded" @bind="editModel.BehandlingId">
                    @foreach (var b in DataService.Behandlinger)
                    {
                        <option value="@b.BehandlingId">@b.Navn</option>
                    }
                </select>
            </div>

            <div>
                <label class="block text-sm text-gray-600 mb-1">Medarbejder</label>
                <select class="w-full border p-2 rounded" @bind="editModel.MedarbejderId">
                    @foreach (var m in DataService.Medarbejdere)
                    {
                        <option value="@m.MedarbejderId">@m.Navn</option>
                    }
                </select>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Dato</label>
                    <input type="date"
                           class="w-full border p-2 rounded"
                           value="@datoInput"
                           @onchange="OnDateChanged" />
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Tid</label>
                    <input type="time"
                           class="w-full border p-2 rounded"
                           value="@tidInput"
                           @onchange="OnTimeChanged" />
                </div>
            </div>



            <div>
                <label class="block text-sm text-gray-600 mb-1">Varighed (min)</label>
                <input type="number" class="w-full border p-2 rounded" @bind="editModel.Varighed" />
            </div>

            <div>
                <label class="block text-sm text-gray-600 mb-1">Status</label>
                <select class="w-full border p-2 rounded" @bind="editModel.Status">
                    @foreach (var s in Enum.GetValues<BookingStatus>())
                    {
                        <option value="@s">@s</option>
                    }
                </select>
            </div>

            

            <div class="flex justify-end gap-2 pt-2">
                <button class="px-4 py-2 border rounded-lg hover:bg-gray-50"
                        @onclick="CloseDialog">
                    Annuller
                </button>

                <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                        @onclick="SaveBooking">
                    Gem
                </button>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation -->
@if (deleteBookingId.HasValue)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <h2 class="text-gray-900 mb-2">Slet booking?</h2>
            <p class="text-gray-600 mb-6">Er du sikker? Dette kan ikke fortrydes.</p>

            <div class="flex justify-end gap-2">
                <button @onclick="@(() => deleteBookingId = null)"
                        class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                    Annuller
                </button>

                <button @onclick="ConfirmDelete"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Slet
                </button>
            </div>
        </div>
    </div>
}

@code {
    private bool showDialog = false;
    private bool isEditing = false;
    private Booking editModel = new();

    private string datoInput = DateTime.Now.ToString("yyyy-MM-dd");
    private string tidInput = DateTime.Now.ToString("HH:mm");

    private int? deleteBookingId;
    private string selectedStatus = "all";
    private string? errorMessage;

    private void OnDateChanged(ChangeEventArgs e)
    {
        datoInput = e.Value?.ToString() ?? DateTime.Now.ToString("yyyy-MM-dd");
    }

    private void OnTimeChanged(ChangeEventArgs e)
    {
        tidInput = e.Value?.ToString() ?? DateTime.Now.ToString("HH:mm");
    }



    private IEnumerable<Booking> SortedFilteredBookinger =>
        DataService.Bookinger
            .Where(b => selectedStatus == "all" || b.Status.ToString() == selectedStatus)
            .OrderBy(b => b.Tidspunkt);

    private void SetStatusFilter(string status) => selectedStatus = status;

    private string GetFilterButtonClass(string status)
    {
        var baseCss = "px-3 py-1 rounded-lg border text-sm ";
        return selectedStatus == status
            ? baseCss + "bg-blue-600 text-white border-blue-600"
            : baseCss + "bg-white text-gray-700 border-gray-300 hover:bg-gray-50";
    }

    private string GetStatusBadgeClass(BookingStatus status) =>
        status switch
        {
            BookingStatus.Bekræftet => "bg-green-100 text-green-700",
            BookingStatus.Afventer => "bg-yellow-100 text-yellow-700",
            BookingStatus.Gennemført => "bg-gray-100 text-gray-700",
            _ => "bg-gray-100 text-gray-700"
        };

    private string GetStatusTitle() =>
        selectedStatus switch
        {
            "Bekræftet" => "Bekræftede bookinger",
            "Afventer" => "Afventende bookinger",
            "Gennemført" => "Gennemførte bookinger",
            _ => "Alle bookinger"
        };

    private void NewBooking()
    {
        isEditing = false;
        editModel = new Booking
        {
            Varighed = 30,
            Status = BookingStatus.Afventer
        };

        datoInput = DateTime.Now.ToString("yyyy-MM-dd");
        tidInput = DateTime.Now.ToString("HH:mm");

        showDialog = true;
    }

    

    private async Task EditBooking(int id)
    {
        var b = await BookingAppService.GetByIdAsync(id);
        if (b == null) return;

        editModel = new Booking
        {
            BookingId = b.BookingId,
            KundeId = b.KundeId,
            BehandlingId = b.BehandlingId,
            MedarbejderId = b.MedarbejderId,
            Tidspunkt = b.Tidspunkt,
            Varighed = b.Varighed,
            Status = b.Status,
            ValgtRabat = b.ValgtRabat
        };

        datoInput = b.Tidspunkt.ToString("yyyy-MM-dd");
        tidInput = b.Tidspunkt.ToString("HH:mm");


        isEditing = true;
        showDialog = true;
    }

    private async Task SaveBooking()
    {
        errorMessage = null; // reset

        if (DateTime.TryParse($"{datoInput} {tidInput}", out var parsed))
        {
            editModel.Tidspunkt = parsed;
        }



        try
        {
            if (isEditing)
                await BookingAppService.UpdateAsync(editModel);
            else
                await BookingAppService.CreateAsync(editModel);

            showDialog = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            await JSRuntime.InvokeVoidAsync("alert", errorMessage);
        }
    }

    private void CloseDialog()
    {
        showDialog = false;
        editModel = new Booking();
    }

    private async Task ConfirmDelete()
    {
        if (!deleteBookingId.HasValue)
            return;

        try
        {
            await BookingAppService.DeleteAsync(deleteBookingId.Value);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            await JSRuntime.InvokeVoidAsync("alert", $"Fejl ved sletning: {ex.Message}");
        }
        finally
        {
            // Uanset om det lykkes eller fejler, luk dialogen
            deleteBookingId = null;
            StateHasChanged();
        }
    }

}
